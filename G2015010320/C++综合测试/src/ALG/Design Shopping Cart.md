## Design of Shopping Cart

### Question
如何设计一个购物车, 可以从商品列表中添加商品, 修改数量, 生成订单, 如果商品数量在1亿以上, 如何设计架构保证安全稳定的,
(multi-tier, MVC, SOA)<p/>
**bonus:**如何设计抢购页面, suppose we have limited products and time

### 问题分析
1. 明确`shopping cart`是针对某个用户唯一，所以数据的应该可以通过用户UID索引查询。
2. 明确每个`shopping cart`应该具备一个商品列表，而且支持“商品列表中添加商品, 修改数量”。
3. 明确用户需要从`shopping cart`生成订单，所以购物车服务应该支持快速生成订单的功能。
4. 对于抢购类商品提供“抢购”功能，需要在购物车服务之上扩展出一个支持异步消息队列的中间服务。

### 系统可能的层次结构和实施方案
1. WEB接入层（multi-tier & MVC）：提供购物车浏览操作的WEB服务WEB1，抢购页面WEB2。
2. SS1: 购物车中间业务服务, 考虑支持通过用户UID的进行负载均衡（multi-tier & SOA）。
3. SS2: 抢购功能中间业务服务, 考虑支持通过用户UID的进行负载均衡（multi-tier & SOA）（可以考虑基于异步分布式消息队列）。
4. CH：用户购物车分布式Cache数据视图，Key是用户UID，Value是购物车商品列表。
5. PL：持久化层：提供用户购物车的持
久化视图，考虑使用mysql，考虑基于用户UID进行散表散库，针对用户id构建索引，用于减轻查询负载。
6. 在中间业务服务 SS1 中，对于购物车的修改、添加以及生产订单操作需要加上分布式锁（用户UID为粒度），用于防止用户多终端并行操作导致出现不一致的状态。
7. SS2 提供“抢购”排队“请求缓冲”的功能，其一旦“抢购”成功，调研 SS1 的接口将商品加入购物车。
8. WEB层提供无状态的查询和更新接口，考虑通过反向代理（nginx）对WEB请求提供负载均衡。
9. SS1 同步操作 CH，异步操作PL，最终保持CH和PL数据视图的一致。
10. SS1-2，考虑利用分布式协调系统（zookeeper集群）进行服务寻址和服务监控，保证没有单点故障和高可用性。
11. 考虑通过SS1-2 的客户端（WEB）使用UID和最终得到服务地址列表进行调用的负载均衡。